# This R script allows exploratory analysis of the output obtained by SimuCell glioma simulations
# To select which simulation to explore, simply select in the dialog any of the four output files generated by the simulation.

if (!require(rgl)) {
  install.packages("rgl", dependencies = TRUE)
}

library(rgl)

#initialize color palette
density_colors=colorRampPalette( c("#5E4FA2" , "#3288BD" , "#66C2A5" , "#ABDDA4" ,
                                   "#E6F598" , "#FFFFBF" , "#FEE08B" , "#FDAE61" ,
                                   "#F46D43" , "#D53E4F" , "#9E0142" ) )


# Choose a data file to analyze

fileName <- file.choose() ## select any of the four output files of the simulation to be explored

# Set the working directory to the directory of the selected file
setwd(dirname(fileName))

# Find all files in the directory that contain the same prefix as the selected file
filePrefix <- strsplit(basename(fileName), split = "__")[[1]][1]
files <- dir(pattern = filePrefix)

# Read in the CloneTable file and split it into subsets based on the time points at which the data was collected
cloneTableFile <- files[grep("CloneTable", files)]
cloneTable <- read.delim(cloneTableFile)
lastRowOfSubset <- which(diff(cloneTable[, 1]) < 0)
intervals <- cbind(c(lastRowOfSubset, nrow(cloneTable)), c(0, lastRowOfSubset + 1))
cloneTableSubsets <- apply(intervals, 1, function(x) {
  temp <- cloneTable[x[1]:x[2], ]
  subsetSizes <- temp[, 2]
  names(subsetSizes) <- temp[, 1]
  return(sort(subsetSizes, decreasing = TRUE))
})

# Obtain CloneTable of final timepoint
tableFinal<-sort(
				cloneTableSubsets[[length(cloneTableSubsets)]],
				decreasing = T)

# calculate number of clones 
clones95<-sum(cumsum(tableFinal)/sum(tableFinal)<.95)


# Read in the FinalPopulation and TrackByHours files
finalPopulationFile <- files[grep("FinalPopulation", files)]
finalPopulation <- read.delim(finalPopulationFile, header = FALSE)
colnames(finalPopulation) <- c("name", "timer", "cycle", "x", "y", "z", "cycleCount")
trackByHoursFile <- files[grep("TrackByHours", files)]
trackByHours <- read.delim(trackByHoursFile)

# Extract relevant parameters from the Parameters file
parametersFile <- files[grep("Parameters", files)]
parameters <- readLines(parametersFile)
interestingParameters <- c("FILE NAME", "brainVoxel", "SCALE_VOX", 
                          "SD_DELTA_CYCLE",  "MIGRATION_UNIT", "EC50",
                           "P_DEATH_T_ZERO", "ALIEN_WEIGHT", "LINEAGE_WEIGHT")
parameterValues <- sapply(interestingParameters, function(x) {
  parameterLine <- grep(x, parameters)[1]
  parameterValue <- parameters[parameterLine]
  names(parameterValue) <- x
  return(parameterValue)
})

# Calculate the density of tumor cells in three-dimensional space (collapsing Y axis)
xIndex <- trunc(finalPopulation[, 4] / 100000 + 50)
zIndex <- trunc(finalPopulation[, 6] / 100000 + 50)
densityTable <- table(xIndex, zIndex)


trackByHours$days<-(1:nrow(trackByHours))/24



par(mfrow=c(2,5))
# 1. Line plot of the population size of cells over time

plot(trackByHours$days,
     trackByHours$popsize,
     type="l",lwd=2,
     ylab="Number of cells",
     xlab = "Time (days)",
     main="Cell growth"
     )

# 2. Log-scale line plot of the population size of cells over time

plot(trackByHours$days,
     trackByHours$popsize,
     type="l",lwd=2,
     log="y",
     ylab="Number of cells",
     xlab = "Time (days)",
     main="Cell growth (log scale)"
)


# 3. Line plot of the median cell cycle length over time

plot(trackByHours$days,
     trackByHours$CycleMedian,
     type="l",lwd=2,
     ylab="Median cell-cycle length (hours)",
     xlab = "Time (days)",
     main="Median cell-cycle length of proliferating cells",
     ylim=c(18,22)
)


# 4. Line plot of the number of clones over time

plot(trackByHours$days,
     trackByHours$nclones,
     type="l",lwd=2,
     ylab="Total number of clones",
     xlab = "Time (days)",
     main="Number of clones over time",
     ylim=c(0,max(trackByHours$nclones))
)




# 5. Line plot of the Shannon diversity over time

plot(trackByHours$days,
     trackByHours$shannon,
     type="l",lwd=2,
     ylab="Shannon entropy",
     xlab = "Time (days)",
     main="Shannon entropy index over time"
)


# 6. Line plot of the percentage of cell death per hour over time

plot(trackByHours$days,
     trackByHours$numberOfDeaths / trackByHours$popsize * 100,
     type="l",lwd=2,
     ylab="Cell death fraction (percentage)",
     xlab = "Time (days)",
     main=" Cell death rate over time"
)


# 7. Histogram of the log10 of clone sizes

hist(log10(tableFinal), freq = F, col="grey95",
	main="Distribution of clone sizes")
lines(density(log10(tableFinal)) , lwd=2 )


# 8. density plot of cell coordinates

image(densityTable,
      col=density_colors(100),
      axes=F,
      main="Simulated tumor morphology")

# 9. piechart of clonal distribution

pie(tableFinal,
    labels = "",
    border = NA,
    col=rainbow(1e4)[as.numeric(names(tableFinal))],
    main=paste0("Clonal composition at final timepoint")


# 10. Plot parameter values

plot.new()
title("Simulation parameter values")
text(0.5,.5,
     paste(parameterValues,collapse="\r\n"))



# 3D plot of final population coloured by cloneID
rgl::plot3d(finalPopulation$x,
            finalPopulation$y,
            finalPopulation$z,
            col=rainbow(1e4)[finalPopulation$name],
            alpha=.3)
